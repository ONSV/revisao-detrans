---
format: 
  onsvpub-html:
    smooth-scroll: true
editor: source
author: 
  - name: João Pedro Melani Saraiva
    affiliation:
    - id: onsv
      name: Observatório Nacional de Segurança Viária
  - name: Daniel Duque
    affiliation: Centro de Liderança Pública
  - name: Pedro Augusto Borges dos Santos
    affiliation: 
      - ref: onsv   
date: last-modified
title-block-banner: true
editor_options: 
  chunk_output_type: console
params:
  state: RO
title: "Avaliação do Nível de Informações Disponibilizadas no Portal do DETRAN - `r params$acronym`"
---

```{r include=FALSE}
params$state

library(tidyverse)
library(here)
library(onsvplot)
library(gt)
library(patchwork)

source(here("R","02-utils.R"))

tbl_blue <- "#99B6C5"
tbl_red <- "#D7191C"
tbl_orange <- "#f05f22"
tbl_yellow <- "#f7951d"
tbl_green <- "#1fa149"
pal <- c(tbl_red, tbl_orange, tbl_yellow, tbl_green)

load(here("data", "revisoes.rda"))
```

```{r}
filtered <- 
  df_revisoes |> 
  nest(.by = uf) |> 
  filter(uf == params$state) |> 
  unnest(cols = everything()) |> 
  select(-uf)
```

```{r}
replace_func <- function(x) {
  str_replace_all(
    x,
    c(
      "period" = "periodicidade",
      "inter" = "interatividade",
      "desagreg" = "nível de desagregação",
      "infracoes" = "infrações",
      "estatistica" = "estatística",
      "educ" = "educação",
      "conteudos" = "conteúdos",
      "divulgacao" = "divulgação",
      "nota_final" = "nota final"
    )
  )
}

str_to_title_func <- function(x) {
  x |> 
    str_to_title() |> 
    str_replace_all(
      c(
        "Cfcs" = "CFCs",
        "De" = "de"
      )
    )
}

tbl_styles <- function(gt) {
  gt |> 
    tab_style(
    style = cell_text(align = "center"),
    locations = cells_stubhead()) |> 
  tab_style(
    style = "vertical-align:middle",
    locations = cells_column_labels()
  ) |>
  tab_style(
    style = cell_fill(color = tbl_blue),
    locations = cells_row_groups()
  ) |> 
  tab_style(
    style = "vertical-align:middle",
    locations = cells_row_groups()
  ) |> 
  tab_options(
    column_labels.background.color = onsv_palette$blue,
    column_labels.font.weight = "bold"
  )
}
```
<!-- ```{r} -->
<!-- df_revisoes |> -->
<!--   mutate(regiao = get_region(uf), .before = 1) |> -->
<!--   mutate( -->
<!--     frota = rowMeans(across(starts_with("frota"))), -->
<!--     condutores = rowMeans(across(starts_with("condutores"))), -->
<!--     infracoes = rowMeans(across(starts_with("infracoes"))), -->
<!--     sinistros = rowMeans(across(starts_with("sinistros"))), -->
<!--     atendimento = rowMeans(across(starts_with("atendimento"))), -->
<!--     educ = rowMeans(across(starts_with("educ"))), -->
<!--     cfcs -->
<!--   ) |> -->
<!--   select(uf, -->
<!--          frota, -->
<!--          condutores, -->
<!--          infracoes, -->
<!--          sinistros, -->
<!--          atendimento, -->
<!--          educ, -->
<!--          cfcs, -->
<!--          ano) |> -->
<!--   pivot_longer(-c(uf, ano)) |> -->
<!--   ggplot(aes(name, uf)) + -->
<!--   geom_tile(aes(fill = value)) + -->
<!--   geom_text(aes( -->
<!--     label = format(value, digits = 1), -->
<!--     color = ifelse(value >= 6, "black", "white") -->
<!--   ), -->
<!--   size = 3) + -->
<!--   facet_wrap(vars(ano)) + -->
<!--   labs(x = NULL, y = NULL) + -->
<!--   scale_color_identity() + -->
<!--   scale_fill_distiller() + -->
<!--   theme_minimal() + -->
<!--   theme(axis.text.x = element_text(angle = 90, vjust = 0.5)) -->
<!-- ``` -->

```{r}
preliminar <- 
  filtered |> 
  mutate(
    frota = rowMeans(across(starts_with("frota"))),
    condutores = rowMeans(across(starts_with("condutores"))),
    infracoes = rowMeans(across(starts_with("infracoes"))),
    sinistros = rowMeans(across(starts_with("sinistros"))),
    atendimento = rowMeans(across(starts_with("atendimento"))),
    educ = rowMeans(across(starts_with("educ")))
  ) |> 
  select(cfcs:last_col())
```

```{r}
preliminar |>
  pivot_longer(-ano) |>
  filter(ano == 2024) |>
  select(-ano) |>
  mutate(name = str_to_title_func(replace_func(name)),
         value = factor(
           if_else(value == 0, "Ausente", "Presente"),
           levels = c("Presente", "Ausente")
         )) |> 
  gt() |> 
  data_color(columns = 2, palette = c(tbl_green, tbl_red)) |> 
  cols_label(
    name = "Categoria", 
    value = "Situação"
  ) |> 
  tbl_styles()
```

```{r}
filtered |>
  pivot_longer(-ano) |>
  pivot_wider(names_from = ano, values_from = value) |>
  mutate(name = replace_func(name)) |>
  separate(name,
           into = c("categoria", "criterio"),
           sep = "_") |>
  mutate(across(categoria:criterio, str_to_title_func),
         criterio = coalesce(criterio, categoria)) |>
  gt(groupname_col = "categoria") |>
  tab_options(row_group.as_column = T) |>
  sub_missing(missing_text = "") |>
  data_color(
    columns = 3:4,
    palette = pal,
    domain = c(0, 10)
  ) |>
  cols_label(criterio = "Critério") |>
  fmt_number(decimals = 1) |> 
  tab_spanner(columns = 3:4, label = "Ano") |> 
  tbl_styles()
```