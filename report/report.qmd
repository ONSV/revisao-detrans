---
title: "Avaliação do Nível de Informações Disponibilizadas nos Portais dos Departamentos Estaduais de Trânsito – DETRANs"
format: 
  onsvpub-html:
    smooth-scroll: true
author: 
  - Pedro Augusto Borges dos Santos
  - João Pedro Melani Saraiva
date: last-modified
title-block-banner: true
editor_options: 
  chunk_output_type: console
bibliography: references.bib
csl: associacao-brasileira-de-normas-tecnicas.csl
---

```{r}
#| include: false

library(tidyverse)
library(here)
library(flextable)
library(onsvplot)
library(scales)
library(geobr)
library(sf)


estados <- read_state()
load(here("data", "revisoes.rda"))

map_blue <- "#77C6ED"
tbl_blue <- "#3d7590"
tbl_red <- "#df555d"
map_red <- "#e47076"
```

### Sobre o relatório {.unnumbered}

#### Como citar {.unnumbered}

#### Licença de uso {.unnumbered}

#### Código livre e aberto {.unnumbered}

## Introdução

### Objetivo

O presente documento tem por objetivo apresentar uma avaliação do nível de informações disponibilizadas nos portais (sítios eletrônicos) dos DETRANs (Departamentos Estaduais de Trânsito) de todas as unidades da federação brasileiras.

Os DETRANs, por sua atuação, trabalham com um grande número de informações relevantes para a gestão do trânsito no país, tendo muitas delas, além do teor formal e burocrático, uma grande utilidade para avaliações no âmbito da segurança viária, tais como: infrações de trânsito, acidentes de trânsito, e habilitação, entre outros.

Nesse sentido, este documento busca apresentar uma análise da situação de cada DETRAN, permitindo obter um panorama de como essas instituições trabalham e disponibilizam informações de interesse social. Além da introdução, o documento compõe-se das seguintes seções: @sec-metodos, com as consultas preliminares, pontuação e critérios estabelecidos; e @sec-resultados, com a pontuação geral em cada categoria analisada, com a evolução das notas resultantes ao longo dos anos e com os exemplos de boas práticas encontradas nos sítios eletrônicos.

### Atribuições do DETRAN

De acordo com o CTB (Código de Trânsito Brasileiro), são competências do DETRAN o planejamento, coordenação, execução e controle relacionados às seguintes áreas: habilitação de condutores, veículos, fiscalização de trânsito, estatísticas e educação para o trânsito.

Na habilitação de condutores, cabe ao DETRAN realizar e controlar o processo de formação, reciclagem e suspensão dos condutores, assim como a expedição e cassação da Licença de Aprendizagem, Permissão para Dirigir e CNH. 

Em relação aos veículos, compete ao DETRAN o seu registro, emplacamento, licenciamento e a expedição do seu Certificado de Registro e Licenciamento Anual.

Na área de fiscalização, o DETRAN deve fazer cumprir a legislação e as normas de trânsito, sendo responsável pela autuação e aplicação de medidas administrativas cabíveis pelas infrações previstas no Código de Trânsito Brasileiro.

Em relação a educação para o trânsito, é responsabilidade do DETRAN a promoção e participação de projetos de educação e segurança no trânsito. Por fim, coleta de dados estatísticos e a elaboração de estudos sobre acidentes de trânsito e suas causas também devem ser cumpridos pelo DETRAN.

### Versão anterior

Este trabalho é uma segunda versão do relatório publicado em 2020 pelo Observatório, que virou uma comunicação técnica publicada no segundo Simpósio de Transportes do Paraná (STPR), também em 2020 [@santos2020]. A elaboração de uma nova versão ira possibilitar a evolução dos portais dos DETRANs de cada estado.

## Métodos {#sec-metodos}

### Consultas Preliminares

O estudo foi realizado por meio do acesso dos sites do DETRAN de cada estado a fim de averiguar a existência de dados estatíticos sobre a frota veicular, condutores habilitados, infrações e sinistros de trânsito. Também foi avaliada a existência de informações relacionadas à educação para o trânsito (campanhas, material educativo, regras de trânsito, etc.), dados quantitivos do atendimento público pelo departamento, disponibilidade de canais de atendimento e dados informativos sobre os centros de formação de condutores do estado em questão. A @tbl-consultas demonstra estes resultados:

```{r}
#| include: false

get_region <- function(acronyms) {
  region_map <- list(
    "Norte" = c("AC", "AM", "AP", "PA", "RO", "RR", "TO"),
    "Nordeste" = c("AL", "BA", "CE", "MA", "PB", "PE", "PI", "RN", "SE"),
    "Centro-Oeste" = c("GO", "MT", "MS", "DF"),
    "Sudeste" = c("ES", "MG", "RJ", "SP"),
    "Sul" = c("PR", "RS", "SC")
  )
  
  region <- sapply(acronyms, function(acronym) {
    for (r in names(region_map)) {
      if (acronym %in% region_map[[r]]) {
        return(r)
      }
    }
    return("Not found")
  })

  return(region)
}

consulta_pre <- df_revisoes |>
  mutate(regiao = get_region(uf), .before = 1) |>
  filter(ano == 2024) |>
  mutate(
    frota = rowSums(across(starts_with("frota"))),
    condutores = rowSums(across(starts_with("condutores"))),
    infracoes = rowSums(across(starts_with("infracoes"))),
    sinistros = rowSums(across(starts_with("sinistros"))),
    atendimento = rowSums(across(starts_with("atendimento"))),
    educ = rowSums(across(starts_with("educ"))),
    cfcs
  ) |>
  select(regiao,
         uf,
         frota,
         condutores,
         infracoes,
         sinistros,
         atendimento,
         educ,
         cfcs) 
```

```{r}
#| tbl-cap: Tabela de consultas preliminares
#| label: tbl-consultas

consulta_pre |>
  mutate(across(where(is.numeric), ~ ifelse(.x == 0, "NÃO", "SIM"))) |>
  arrange(desc(regiao)) |>
  flextable() |>
  merge_v(j = ~ regiao) |>
  set_header_labels(
    regiao = "Região",
    uf = "UF",
    frota = "Frota veicular",
    condutores = "Condutores habilitados",
    infracoes = "Infrações",
    sinistros = "Sinistros",
    atendimento = "Atendimento ao público",
    educ = "Educação para o trânsito",
    cfcs = "CFC"
  ) |>
  bg(
    j = ~ . - regiao - uf,
    bg = col_factor(
      palette = c(tbl_red, tbl_blue),
      domain = c("SIM", "NÃO")
    ),
    part = "body"
  ) |>
  color(j = ~ . - regiao - uf,
        color = "white",
        part = "body") |>
  theme_vanilla() |>
  surround(
    j = ~ . - regiao - uf,
    border.top = officer::fp_border(color = "grey90"),
    border.bottom = officer::fp_border(color = "grey90"),
  ) |>
  align(align = "center", part = "all") |> 
  fontsize(size = 9, part = "all") |> 
  line_spacing(space = 0.55, part = "body") |> 
  line_spacing(space = 0.6, part = "header") |> 
  color(color = "white", part = "header") |> 
  bg(bg = onsv_palette$blue, part = "header")
```

### Critérios de Avaliação

A partir das categorias anteriormente discutidas, critérios de avaliação foram estabelecidos para quantificar a disponibilidade de dados e informações de cada um dos DETRANs. Assim sendo, são concedidos níveis de desempenho que equivalem a pontuações para cada um dos critérios aferidos: **Melhor Prática** - Nota 10; **Prática Intermediária** - Nota 6,67; **Prática Inicial** - Nota 3,34 e **Prática Ausente** - Nota 0.

A avaliação dos dados estatísticos de frota veicular, condutores habilitados, infrações e sinistros de trânsito se baseou em:

-   Periodicidade: quantidade de anos disponíveis;

-   Interatividade: tipo de arquivos ou informações disponíveis e;

-   Nível de desagregação: quantidade de variáveis disponíveis para análise.

A relação destes critérios está ilustrada na @tbl-criterios:

```{r}
#| tbl-cap: Tabela de critérios de avaliação para frota, condutores habilitados, infrações e sinistros
#| label: tbl-criterios

criterio <- data.frame(
  notas = c(3.3, 6.7, 10),
  periodicidade = c(
    "3 anos de atraso/ < 5 anos",
    "2 anos de atraso/ < 5 anos",
    "2 anos de atraso/ > 5 anos"
  ),
  interatividade = c("txt", "xlsx", "Interativo"),
  desagreg = c("1 a 2 desagregações", "3 a 4 desagregações", "5+ desagregações")
)

rbind(
  mutate(criterio, categoria = "frota"),
  mutate(criterio, categoria = "condutores"),
  mutate(
    criterio,
    categoria = "infrações",
    desagreg = c("1 desagregação", "2 desagregações", "3+ desagregações")
  ),
  mutate(
    criterio,
    categoria = "sinistros",
    desagreg = c("1 a 5 desagregações", "6 a 10 desagregações", "11+ desagregações")
  )
) |>
  relocate(categoria, periodicidade, interatividade, desagreg, notas) |>
  mutate(categoria = str_to_title(categoria)) |>
  rename_with(str_to_title) |>
  rename(`Nível de desagregação` = Desagreg) |>
  flextable() |>
  merge_v(j = ~ Categoria) |>
  theme_vanilla() |>
  align(align = "center", part = "all") |>
  autofit() |>
  color(color = "white", part = "header") |>
  bg(bg = onsv_palette$blue, part = "header")
```

As informações sobre o atendimento ao público, educação para o trânsito e CFCs foram aferidas por outros critérios mais específicos por não se tratarem de dados estatísticos, exigindo uma mudança na abordagem de avaliação. As Tabelas [-@tbl-atend], [-@tbl-educ] e [-@tbl-cfcs] demonstram os critérios para estes casos:

```{r}
#| tbl-cap: Tabela de critérios de avaliação para atendimento ao público
#| label: tbl-atend

tbl_atend <- data.frame(
  notas = c(3.3, 6.7, 10),
  stats =  c(
    "3 anos de atraso/ < 5 anos",
    "2 anos de atraso/ < 5 anos",
    "2 anos de atraso/ > 5 anos"
  ),
  canais = c(
    "Atendimento por telefone",
    "Atendimento por (1) e e-mail",
    "Atendimento por (2) e mensagem"
  )
) |>
  relocate(stats, canais, notas) |>
  flextable() |>
  theme_vanilla() |>
  color(color = "white", part = "header") |>
  bg(bg = onsv_palette$blue, part = "header") |>
  set_header_labels(stats = "Estatísticas",
                    canais = "Canais de atendimento",
                    notas = "Notas") |>
  align(align = "center", part = "all") |> 
  autofit(add_w = 2)

tbl_atend
```

```{r}
#| tbl-cap: Tabela de critérios de avaliação para conteúdo educativo
#| label: tbl-educ

tbl_educ <- data.frame(
  conteudo = c(
    "Dicas, sugestões de leitura, cartilhas, orientações gerais e cadernos pedagógicos."
  ),
  divulgacao = c("Cursos, palestras, ações, projetos e campanhas.")
) |>
  flextable() |>
  theme_vanilla() |>
  color(color = "white", part = "header") |>
  bg(bg = onsv_palette$blue, part = "header") |>
  set_header_labels(conteudo = "Conteúdos didáticos",
                    divulgacao = "Divulgação de atividades") |>
  align(align = "center", part = "all") |> 
  autofit()

tbl_educ
```

```{r}
#| tbl-cap: Tabela de critérios de avaliação para informações sobre CFCs
#| label: tbl-cfcs

tbl_cfc <- data.frame(
  lista = c(
    "Quantidade de CFCs no estado",
    "Lista completa dos CFCs",
    "Informações adicionais sobre o índice de aprovação dos alunos, quais CFCs possuem simuladores de direção, número de habilitados e informações sobre o credenciamento."
  ),
  notas = c(3.3, 6.7, 10)
) |>
  flextable() |>
  theme_vanilla() |>
  color(color = "white", part = "header") |>
  bg(bg = onsv_palette$blue, part = "header") |>
  set_header_labels(lista = "Lista sobre CFCs credenciados",
                    notas = "Notas") |>
  align(align = "center", part = "all") |> 
  autofit()

tbl_cfc
```

## Resultados {#sec-resultados}

### Frota de Veículos

```{r}
frota <- df_revisoes |> 
  filter(ano == 2024) |>
  select(uf, starts_with("frota"), nota_final) |> 
  mutate(regiao = get_region(uf), .before = 1,
         nota_final = round(nota_final, 2)) |> 
  arrange(desc(regiao))
```

A @tbl-frota aponta a qualidade dos dados estatísticos da frota veicular como fornecidos pelo portal dos DETRANs. A periodicidade aparenta ser o critério de melhor performance na maior parte dos departamentos:

```{r}
#| tbl-cap: Tabela de desempenho para dados de frota
#| label: tbl-frota

frota |>
  mutate(across(
    starts_with("frota"),
    ~ case_match(
      .x,
      10.0 ~ "Ótimo",
      6.7 ~ "Intermediário",
      3.3 ~ "Inicial",
      0 ~ "Ausente"
    )
  )) |>
  flextable() |>
  merge_v(j = ~ regiao) |>
  set_header_labels(
    regiao = "Região",
    uf = "UF",
    frota_period = "Periodicidade",
    frota_inter = "Interatividade",
    frota_desagreg = "Nível de desagregação",
    nota_final = "Nota Final"
  ) |>
  theme_vanilla() |>
  align(align = "center", part = "all") |>
  color(color = "white", part = "header") |>
  color(j = ~ . - regiao - uf,
        color = "white",
        part = "body") |>
  bg(bg = onsv_palette$blue, part = "header") |>
  bg(
    bg = col_numeric(
      palette = c(tbl_red, tbl_blue),
      domain = c(0, 10)
    ),
    part = "body",
    j = ~ nota_final
  ) |>
  bg(
    bg = col_factor(
      palette = c(tbl_red, tbl_blue),
      domain = c("Ótimo", "Intermediário", "Inicial", "Ausente")
    ),
    part = "body",
    j = ~ . - uf - regiao - nota_final
  ) |>
  bold(part = "body", j = ~ . - regiao - uf) |>
  surround(
    j = ~ . - regiao - uf,
    border.top = officer::fp_border(color = "grey90"),
    border.bottom = officer::fp_border(color = "grey90"),
  ) |>
  line_spacing(space = 0.4, part = "body") |>
  line_spacing(space = 0.6, part = "header") |>
  autofit()
```

A @fig-map-frota aponta a nota média dos três critérios para os dados de frota veicular dos departamentos de cada estado. Em destaque, estão:

-   RJ, RO e SE: 10 pontos e;

-   GO, MA, MS, PE, RS, SC, SP: 8,9 pontos.

```{r}
#| fig-cap: Mapa de nota média para dados de frota
#| label: fig-map-frota

frota_map <- 
  frota |> 
  rename(abbrev_state = uf) |> 
  merge(estados) |> 
  mutate(nota_frota = rowMeans(across(starts_with("frota")))) |>
  mutate(
    nudge_y_text = case_match(
      abbrev_state,
      "DF" ~ 1,
      "RN" ~ 0.25,
      "SE" ~ -0.6,
      "AL" ~ -0.4,
      "RJ" ~ -1,
      "AC" ~ 0.5,
      .default = 0
    ),
    nudge_x_text = case_match(
      abbrev_state,
      "PB" ~ 3,
      "PE" ~ 3.9,
      "AL" ~ 1.75,
      "ES" ~ 1.60,
      "SE" ~ 1,
      "RJ" ~ 1,
      .default = 0
    )
  ) |> 
  st_as_sf()

ggplot(frota_map) + 
  geom_sf(aes(fill = nota_frota)) +
  geom_sf_text(aes(label = abbrev_state), 
               size = 2,
               color = "grey20",
               nudge_x = frota_map$nudge_x_text,
               nudge_y = frota_map$nudge_y_text) +
  scale_fill_gradient(high = map_blue, low = map_red, labels = comma_format(decimal.mark = ",", big.mark = "."), guide = "legend") +
  theme_minimal() +
  theme(
    legend.justification = c("right", "top")
  ) +
  labs(fill = "Nota Média", x = NULL, y = NULL)
```

### Condutores Habilitados

### CFCs

### Infrações

### Sinistros de Trânsito

### Educação para o Trânsito

### Evolução dos Resultados

### Boas Práticas

## Apêndice - Links acessados {.unnumbered}

## Referências {.unnumbered}
